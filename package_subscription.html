<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اشتراك الباقات - LeenClasses</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --info-color: #17a2b8;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Cairo", sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
        }
        
        .back-btn {
            color: white;
            text-decoration: none;
            font-size: 1.2rem;
            position: absolute;
            right: 20px;
            top: 20px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        h1 {
            margin-bottom: 10px;
        }
        
        .subscription-steps {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 15px;
            position: relative;
            min-width: 80px;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            background-color: #ddd;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
            font-weight: bold;
            color: #666;
            transition: all 0.3s;
        }
        
        .step.active .step-number {
            background-color: var(--secondary-color);
            color: white;
            transform: scale(1.1);
        }
        
        .step.completed .step-number {
            background-color: var(--success-color);
            color: white;
        }
        
        .step-title {
            font-size: 0.9rem;
            color: #666;
            text-align: center;
            transition: all 0.3s;
        }
        
        .step.active .step-title {
            color: var(--primary-color);
            font-weight: bold;
        }
        
        .step.completed .step-title {
            color: var(--success-color);
        }
        
        .step::after {
            content: '';
            position: absolute;
            top: 20px;
            right: -30px;
            width: 30px;
            height: 2px;
            background-color: #ddd;
            transition: all 0.3s;
        }
        
        .step:last-child::after {
            display: none;
        }
        
        .step.completed::after {
            background-color: var(--success-color);
        }
        
        .content-section {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .content-section.active {
            display: block;
        }
        
        /* خطوة اختيار الباقة */
        .pricing-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .pricing-card {
            background: white;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: 2px solid #ddd;
            transition: all 0.3s;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .pricing-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }
        
        .pricing-card.selected {
            border-color: var(--secondary-color);
            background-color: #f0f7ff;
            transform: translateY(-5px);
        }
        
        .pricing-card.popular {
            border-color: var(--warning-color);
        }
        
        .popular-badge {
            position: absolute;
            top: -10px;
            left: 20px;
            background-color: var(--warning-color);
            color: white;
            padding: 3px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .plan-name {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .plan-price {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        .price-period {
            font-size: 1rem;
            color: #666;
            font-weight: normal;
        }
        
        .installment-option {
            background-color: #f8f9fa;
            padding: 8px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            text-align: center;
            border: 1px solid #eee;
        }
        
        .plan-features {
            list-style: none;
            margin-bottom: 20px;
            flex-grow: 1;
        }
        
        .plan-features li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .plan-features li:last-child {
            border-bottom: none;
        }
        
        .feature-icon {
            margin-left: 10px;
        }
        
        .feature-available {
            color: var(--success-color);
        }
        
        .feature-unavailable {
            color: #ccc;
        }
        
        .select-plan-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: auto;
        }
        
        .select-plan-btn:hover {
            background-color: #2980b9;
        }
        
        /* خطوة معلومات الدفع */
        .payment-form {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: "Cairo", sans-serif;
            transition: border 0.3s;
            background-color: #fff;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            border-color: var(--secondary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .payment-methods {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .payment-method {
            flex: 1;
            min-width: 120px;
            text-align: center;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .payment-method.selected {
            border-color: var(--secondary-color);
            background-color: #f0f7ff;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .payment-method i {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #666;
        }
        
        .payment-method.selected i {
            color: var(--secondary-color);
        }
        
        /* خيار الدفع كضيف */
        .guest-toggle {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .guest-toggle label {
            margin-right: 10px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--success-color);
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        /* خطوة تأكيد الاشتراك */
        .summary-card {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        
        .summary-row:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.1rem;
            color: var(--primary-color);
        }
        
        /* أزرار التنقل */
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        
        .nav-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-prev {
            background-color: #ddd;
            color: #333;
        }
        
        .btn-next {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .btn-complete {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-prev:hover {
            background-color: #ccc;
        }
        
        .btn-next:hover {
            background-color: #2980b9;
        }
        
        .btn-complete:hover {
            background-color: #27ae60;
        }
        
        /* رسالة النجاح */
        .success-message {
            text-align: center;
            padding: 50px 20px;
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .success-icon {
            font-size: 5rem;
            color: var(--success-color);
            margin-bottom: 20px;
            animation: bounce 1s;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
            40% {transform: translateY(-20px);}
            60% {transform: translateY(-10px);}
        }
        
        .whats-next {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            text-align: right;
        }
        
        /* التكيف مع الشاشات الصغيرة */
        @media (max-width: 768px) {
            .pricing-cards {
                grid-template-columns: 1fr;
            }
            
            .payment-methods {
                flex-direction: column;
            }
            
            .step::after {
                display: none;
            }
            
            .step {
                margin-bottom: 20px;
            }
            
            .navigation-buttons {
                flex-direction: column-reverse;
                gap: 10px;
            }
            
            .nav-btn {
                width: 100%;
                justify-content: center;
            }
        }
        
        /* تحميل */
        .loading {
            text-align: center;
            padding: 30px;
            grid-column: 1 / -1;
        }
        
        .loading i {
            font-size: 2rem;
            color: var(--secondary-color);
            margin-bottom: 15px;
        }
        
        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .nav-btn:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* رسائل الخطأ */
        .error-message {
            color: var(--accent-color);
            background-color: #fdecea;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <a href="index.html" class="back-btn">
                <i class="fas fa-arrow-right"></i> رجوع
            </a>
            <h1>اشتراك الباقات</h1>
            <p>اختر الباقة المناسبة لك واكمل عملية الاشتراك</p>
        </div>
    </header>
    
    <div class="container">
        <!-- خطوات الاشتراك -->
        <div class="subscription-steps">
            <div class="step active" id="step1">
                <div class="step-number">1</div>
                <div class="step-title">اختر الباقة</div>
            </div>
            <div class="step" id="step2">
                <div class="step-number">2</div>
                <div class="step-title">معلومات الدفع</div>
            </div>
            <div class="step" id="step3">
                <div class="step-number">3</div>
                <div class="step-title">تأكيد الاشتراك</div>
            </div>
            <div class="step" id="step4">
                <div class="step-number">4</div>
                <div class="step-title">اكتمل</div>
            </div>
        </div>
        
        <!-- رسائل الخطأ -->
        <div class="error-message" id="errorMessage"></div>
        
        <!-- محتوى الخطوات -->
        <div class="content-sections">
            <!-- الخطوة 1: اختيار الباقة -->
            <div class="content-section active" id="section1">
                <h2 style="margin-bottom: 20px;">اختر الباقة المناسبة لك</h2>
                <div class="pricing-cards" id="plansContainer">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i> جاري تحميل الباقات...
                    </div>
                </div>
                <div class="navigation-buttons">
                    <button class="nav-btn btn-prev" disabled>
                        <i class="fas fa-arrow-left"></i> السابق
                    </button>
                    <button class="nav-btn btn-next" id="toStep2" disabled>
                        التالي <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- الخطوة 2: معلومات الدفع -->
            <div class="content-section" id="section2">
                <h2 style="margin-bottom: 20px;">معلومات الدفع</h2>
                <div class="payment-form">
                    <!-- خيار الدفع كضيف -->
                    <div class="guest-toggle">
                        <label for="guestCheckoutToggle">الدفع كضيف</label>
                        <label class="switch">
                            <input type="checkbox" id="guestCheckoutToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div id="registerFields">
                        <div class="form-group">
                            <label for="fullName">الاسم بالكامل</label>
                            <input type="text" id="fullName" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="email">البريد الإلكتروني</label>
                            <input type="email" id="email" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="phone">رقم الهاتف</label>
                            <input type="tel" id="phone" required>
                        </div>
                        
                        <div class="form-group" id="passwordField">
                            <label for="password">كلمة المرور (اختياري)</label>
                            <input type="password" id="password" placeholder="اختياري - لإنشاء حساب">
                            <small>إذا تركت هذا الحقل فارغاً، سيتم إنشاء حساب بكلمة مرور عشوائية</small>
                        </div>
                    </div>
                    
                    <div id="guestFields" style="display: none;">
                        <div class="form-group">
                            <label for="guestPhone">رقم الهاتف</label>
                            <input type="tel" id="guestPhone" required>
                            <small>سيتم إرسال تفاصيل الاشتراك إلى هذا الرقم</small>
                        </div>
                    </div>
                    
                    <h3 style="margin: 20px 0 15px;">طريقة الدفع</h3>
                    <div class="payment-methods">
                        <div class="payment-method" data-method="vodafone_cash">
                            <i class="fas fa-mobile-alt"></i>
                            <p>فودافون كاش</p>
                        </div>
                        <div class="payment-method" data-method="credit_card">
                            <i class="far fa-credit-card"></i>
                            <p>بطاقة ائتمانية</p>
                        </div>
                        <div class="payment-method" data-method="bank_transfer">
                            <i class="fas fa-university"></i>
                            <p>تحويل بنكي</p>
                        </div>
                        <div class="payment-method" data-method="installment">
                            <i class="fas fa-calendar-alt"></i>
                            <p>تقسيط</p>
                        </div>
                    </div>
                    
                    <input type="hidden" id="paymentMethod" value="">
                    
                    <!-- حقول بطاقة الائتمان -->
                    <div class="form-group" id="creditCardFields" style="display: none;">
                        <label for="cardNumber">رقم البطاقة</label>
                        <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" data-lpignore="true">
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                            <div>
                                <label for="expiryDate">تاريخ الانتهاء</label>
                                <input type="text" id="expiryDate" placeholder="MM/YY" data-lpignore="true">
                            </div>
                            <div>
                                <label for="cvv">CVV</label>
                                <input type="text" id="cvv" placeholder="123" data-lpignore="true">
                            </div>
                        </div>
                    </div>
                    
                    <!-- حقول فودافون كاش -->
                    <div class="form-group" id="vodafoneCashFields" style="display: none;">
                        <p>برجاء استخدام رقم الهاتف التالي للدفع عبر فودافون كاش:</p>
                        <p style="font-weight: bold; font-size: 1.2rem; text-align: center; margin: 10px 0;">01012345678</p>
                        <p>ثم أدخل رقم التحويل أدناه:</p>
                        <input type="text" id="vodafoneTransaction" placeholder="رقم التحويل">
                    </div>
                    
                    <!-- حقول التحويل البنكي -->
                    <div class="form-group" id="bankTransferFields" style="display: none;">
                        <p>برجاء التحويل إلى الحساب البنكي التالي:</p>
                        <p style="margin: 10px 0;">
                            <strong>اسم البنك:</strong> بنك مصر<br>
                            <strong>رقم الحساب:</strong> 123456789<br>
                            <strong>اسم المستفيد:</strong> LeenClasses
                        </p>
                        <p>ثم أدخل رقم الإيصال أدناه:</p>
                        <input type="text" id="bankReceipt" placeholder="رقم الإيصال">
                    </div>
                    
                    <!-- حقول التقسيط -->
                    <div class="form-group" id="installmentFields" style="display: none;">
                        <label for="installmentMonths">عدد الأشهر</label>
                        <select id="installmentMonths">
                            <option value="3">3 أشهر</option>
                            <option value="6">6 أشهر</option>
                            <option value="12">12 شهر</option>
                        </select>
                        
                        <div id="installmentSummary" style="margin-top: 15px; padding: 15px; background-color: #f8f9fa; border-radius: 5px; display: none;">
                            <p>سيتم تقسيم المبلغ إلى <span id="installmentCount">3</span> أقساط شهرية بقيمة <span id="installmentAmount">500</span> ج.م لكل قسط</p>
                            <p>الدفعة الأولى اليوم، ثم يوم <span id="nextPaymentDate">15</span> من كل شهر</p>
                        </div>
                    </div>
                </div>
                <div class="navigation-buttons">
                    <button class="nav-btn btn-prev" id="toStep1">
                        <i class="fas fa-arrow-left"></i> السابق
                    </button>
                    <button class="nav-btn btn-next" id="toStep3">
                        التالي <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- الخطوة 3: تأكيد الاشتراك -->
            <div class="content-section" id="section3">
                <h2 style="margin-bottom: 20px;">تأكيد الاشتراك</h2>
                <div class="summary-card">
                    <h3 style="margin-bottom: 20px; color: var(--primary-color);">تفاصيل الاشتراك</h3>
                    
                    <div class="summary-row">
                        <span>الباقة المختارة:</span>
                        <span id="summaryPlanName">الباقة الأساسية</span>
                    </div>
                    
                    <div class="summary-row">
                        <span>المدة:</span>
                        <span id="summaryDuration">12 شهر</span>
                    </div>
                    
                    <div class="summary-row">
                        <span>طريقة الدفع:</span>
                        <span id="summaryPaymentMethod">فودافون كاش</span>
                    </div>
                    
                    <div id="installmentSummaryRow" style="display: none;">
                        <div class="summary-row">
                            <span>نظام الدفع:</span>
                            <span id="summaryInstallmentPlan">3 أقساط شهرية</span>
                        </div>
                        <div class="summary-row">
                            <span>قيمة القسط:</span>
                            <span id="summaryInstallmentAmount">500 ج.م</span>
                        </div>
                    </div>
                    
                    <div class="summary-row">
                        <span>المبلغ:</span>
                        <span id="summaryAmount">1500 ج.م</span>
                    </div>
                    
                    <div class="summary-row">
                        <span>الضريبة:</span>
                        <span id="summaryTax">0 ج.م</span>
                    </div>
                    
                    <div class="summary-row">
                        <span>الإجمالي:</span>
                        <span id="summaryTotal">1500 ج.م</span>
                    </div>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <label>
                            <input type="checkbox" id="agreeTerms" required>
                            أوافق على <a href="terms.html" target="_blank">الشروط والأحكام</a> و <a href="privacy.html" target="_blank">سياسة الخصوصية</a>
                        </label>
                    </div>
                </div>
                <div class="navigation-buttons">
                    <button class="nav-btn btn-prev" id="toStep2">
                        <i class="fas fa-arrow-left"></i> السابق
                    </button>
                    <button class="nav-btn btn-complete" id="completeSubscription">
                        <i class="fas fa-check-circle"></i> اكمل الاشتراك
                    </button>
                </div>
            </div>
            
            <!-- الخطوة 4: اكتمال الاشتراك -->
            <div class="content-section" id="section4">
                <div class="success-message">
                    <div class="success-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h2 style="margin-bottom: 15px;">تمت عملية الاشتراك بنجاح!</h2>
                    <p style="margin-bottom: 25px; font-size: 1.1rem;">
                        شكراً لاشتراكك معنا. يمكنك الآن البدء باستخدام جميع مميزات الباقة.
                    </p>
                    <p id="transactionDetails" style="margin-bottom: 30px;">
                        رقم العملية: <strong id="transactionId">SUB-123456</strong>
                    </p>
                    
                    <div class="whats-next">
                        <h3>ما التالي؟</h3>
                        <ul style="text-align: right; margin-right: 20px; margin-top: 10px;">
                            <li>ستتلقى رسالة تأكيد بالبريد الإلكتروني و/أو الهاتف</li>
                            <li>يمكنك الوصول إلى المحتوى مباشرة من لوحة التحكم</li>
                            <li>لأي استفسارات، لا تتردد في التواصل مع الدعم الفني</li>
                        </ul>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <a href="dashboard.html" class="nav-btn btn-complete" style="display: inline-block; text-decoration: none; margin: 0 10px;">
                            <i class="fas fa-tachometer-alt"></i> الذهاب إلى لوحة التحكم
                        </a>
                        <a href="courses.html" class="nav-btn" style="display: inline-block; text-decoration: none; margin: 0 10px; background-color: var(--primary-color);">
                            <i class="fas fa-book-open"></i> تصفح الدورات
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-functions-compat.js"></script>

    <script>
        // التهيئة باستخدام بياناتك
        const firebaseConfig = {
            apiKey: "AIzaSyCdqZzMGmJs6PrhF3mVzoM8FlUSamh1FO0",
            authDomain: "leeneduclasses-2022.firebaseapp.com",
            projectId: "leeneduclasses-2022",
            storageBucket: "leeneduclasses-2022.appspot.com",
            messagingSenderId: "850348851753",
            appId: "1:850348851753:web:278a2902dc2696268b9238",
            measurementId: "G-WEK2KG58NM"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const functions = firebase.functions();

        // متغيرات التطبيق
        let selectedPlan = null;
        let currentStep = 1;
        let subscriptionId = '';
        let isGuestCheckout = false;
        let paymentMethod = '';
        let installmentPlan = null;

        // عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // تحميل الباقات من Firebase
                await loadPlans();
                
                // إعداد مستمعي الأحداث
                setupEventListeners();
                
                // إذا كان المستخدم مسجلاً، تعبئة بياناته تلقائياً
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        document.getElementById('email').value = user.email || '';
                        
                        // جلب بيانات المستخدم الإضافية
                        const userDoc = await db.collection('users').doc(user.uid).get();
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            document.getElementById('fullName').value = userData.name || '';
                            document.getElementById('phone').value = userData.phone || '';
                        }
                    }
                });
                
                // إخفاء رسالة الخطأ بعد 5 ثواني
                setInterval(() => {
                    const errorMessage = document.getElementById('errorMessage');
                    if (errorMessage.style.display === 'block') {
                        errorMessage.style.display = 'none';
                    }
                }, 5000);
                
            } catch (error) {
                showError('حدث خطأ أثناء تحميل الصفحة. يرجى المحاولة مرة أخرى.');
                console.error('Initialization error:', error);
            }
        });

        // عرض رسالة خطأ
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }

        // تحميل الباقات من Firebase
        async function loadPlans() {
            try {
                const querySnapshot = await db.collection('pricingPlans')
                    .orderBy('order')
                    .get();
                
                const plansContainer = document.getElementById('plansContainer');
                plansContainer.innerHTML = '';
                
                if (querySnapshot.empty) {
                    plansContainer.innerHTML = `
                        <div class="error-message" style="display: block; grid-column: 1 / -1;">
                            لا توجد باقات متاحة حالياً. يرجى المحاولة لاحقاً.
                        </div>
                    `;
                    return;
                }
                
                querySnapshot.forEach(doc => {
                    const plan = doc.data();
                    displayPlanCard(doc.id, plan);
                });
                
            } catch (error) {
                console.error('Error loading plans:', error);
                showError('حدث خطأ أثناء تحميل الباقات. يرجى المحاولة مرة أخرى.');
            }
        }

        // عرض بطاقة الباقة
        function displayPlanCard(planId, plan) {
            const plansContainer = document.getElementById('plansContainer');
            const planCard = document.createElement('div');
            planCard.className = `pricing-card ${plan.popular ? 'popular' : ''}`;
            
            let featuresHTML = '';
            plan.features.forEach(feature => {
                featuresHTML += `
                    <li>
                        <span>${feature.text}</span>
                        <i class="fas ${feature.available ? 'fa-check feature-available' : 'fa-times feature-unavailable'}"></i>
                    </li>
                `;
            });
            
            // حساب سعر التقسيط إذا كان متاحاً
            let installmentHTML = '';
            if (plan.installmentAvailable) {
                const monthlyPrice = Math.ceil(plan.price / 3);
                installmentHTML = `
                    <div class="installment-option">
                        <i class="fas fa-calendar-alt" style="color: var(--info-color);"></i>
                        ${monthlyPrice} ${plan.currency}/شهر لمدة 3 أشهر
                    </div>
                `;
            }
            
            planCard.innerHTML = `
                ${plan.popular ? '<div class="popular-badge">الأكثر شيوعاً</div>' : ''}
                <h3 class="plan-name">${plan.name}</h3>
                <div class="plan-price">
                    ${plan.price} ${plan.currency}
                    <span class="price-period">/ ${plan.duration} أشهر</span>
                </div>
                ${installmentHTML}
                <ul class="plan-features">
                    ${featuresHTML}
                </ul>
                <button class="select-plan-btn" data-id="${planId}">
                    اختر هذه الباقة
                </button>
            `;
            
            plansContainer.appendChild(planCard);
            
            // إضافة مستمع حدث لزر الاختيار
            planCard.querySelector('.select-plan-btn').addEventListener('click', () => {
                selectPlan(planId, plan);
            });
        }

        // اختيار الباقة
        function selectPlan(planId, plan) {
            // إزالة التحديد من جميع البطاقات
            document.querySelectorAll('.pricing-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // تحديد البطاقة المختارة
            document.querySelector(`.select-plan-btn[data-id="${planId}"]`).parentElement.classList.add('selected');
            
            // حفظ الباقة المختارة
            selectedPlan = {
                id: planId,
                ...plan
            };
            
            // تفعيل زر التالي
            document.getElementById('toStep2').disabled = false;
            
            // تعبئة بيانات الباقة في الخطوة الثالثة
            updateSummary();
        }

        // تحديث ملخص الاشتراك
        function updateSummary() {
            if (!selectedPlan) return;
            
            document.getElementById('summaryPlanName').textContent = selectedPlan.name;
            document.getElementById('summaryDuration').textContent = selectedPlan.duration + ' أشهر';
            
            if (installmentPlan) {
                document.getElementById('installmentSummaryRow').style.display = 'block';
                document.getElementById('summaryInstallmentPlan').textContent = 
                    `${installmentPlan.months} أقساط شهرية`;
                document.getElementById('summaryInstallmentAmount').textContent = 
                    `${installmentPlan.monthlyPayment} ${selectedPlan.currency}`;
                document.getElementById('summaryAmount').textContent = 
                    `${selectedPlan.price} ${selectedPlan.currency}`;
                document.getElementById('summaryTotal').textContent = 
                    `${selectedPlan.price} ${selectedPlan.currency}`;
            } else {
                document.getElementById('installmentSummaryRow').style.display = 'none';
                document.getElementById('summaryAmount').textContent = 
                    `${selectedPlan.price} ${selectedPlan.currency}`;
                document.getElementById('summaryTotal').textContent = 
                    `${selectedPlan.price} ${selectedPlan.currency}`;
            }
        }

        // الانتقال بين الخطوات
function goToStep(step) {
    // لا تتحقق من صحة البيانات إذا كنا نرجع للخلف
    if (step < currentStep) {
        changeStep(step);
        return;
    }
    
    // التحقق من صحة البيانات فقط عند التقدم للأمام
    if (currentStep === 1 && !selectedPlan) {
        showError('الرجاء اختيار باقة قبل المتابعة');
        return;
    }
    
    if (currentStep === 2 && !validatePaymentInfo()) {
        return;
    }
    
    changeStep(step);
}

function changeStep(step) {
    // إخفاء جميع الأقسام
    document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
    });
    
    // تحديث حالة الخطوات
    document.querySelectorAll('.step').forEach(stepElement => {
        stepElement.classList.remove('active', 'completed');
    });
    
    // تنشيط الخطوة الحالية والخطوات السابقة
    for (let i = 1; i <= 4; i++) {
        const stepElement = document.getElementById(`step${i}`);
        if (i < step) {
            stepElement.classList.add('completed');
        } else if (i === step) {
            stepElement.classList.add('active');
        }
    }
    
    // إظهار القسم المطلوب
    document.getElementById(`section${step}`).classList.add('active');
    currentStep = step;
    
    // تعطيل أزرار التنقل حسب الحاجة
    document.querySelector('.btn-prev').disabled = step === 1;
}

        // إعداد مستمعي الأحداث
        function setupEventListeners() {
            // التنقل بين الخطوات
            document.getElementById('toStep1').addEventListener('click', () => goToStep(1));
            document.getElementById('toStep2').addEventListener('click', () => goToStep(2));
            document.getElementById('toStep3').addEventListener('click', () => goToStep(3));
            
            // خيار الدفع كضيف
            document.getElementById('guestCheckoutToggle').addEventListener('change', function() {
                isGuestCheckout = this.checked;
                document.getElementById('registerFields').style.display = this.checked ? 'none' : 'block';
                document.getElementById('guestFields').style.display = this.checked ? 'block' : 'none';
                document.getElementById('passwordField').style.display = this.checked ? 'none' : 'block';
            });
            
            // اختيار طريقة الدفع
            document.querySelectorAll('.payment-method').forEach(method => {
                method.addEventListener('click', function() {
                    document.querySelectorAll('.payment-method').forEach(m => {
                        m.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    
                    paymentMethod = this.getAttribute('data-method');
                    document.getElementById('paymentMethod').value = paymentMethod;
                    document.getElementById('summaryPaymentMethod').textContent = this.querySelector('p').textContent;
                    
                    // إظهار حقول الدفع المناسبة
                    document.getElementById('creditCardFields').style.display = 'none';
                    document.getElementById('vodafoneCashFields').style.display = 'none';
                    document.getElementById('bankTransferFields').style.display = 'none';
                    document.getElementById('installmentFields').style.display = 'none';
                    
                    if (paymentMethod === 'credit_card') {
                        document.getElementById('creditCardFields').style.display = 'block';
                    } else if (paymentMethod === 'vodafone_cash') {
                        document.getElementById('vodafoneCashFields').style.display = 'block';
                    } else if (paymentMethod === 'bank_transfer') {
                        document.getElementById('bankTransferFields').style.display = 'block';
                    } else if (paymentMethod === 'installment') {
                        if (selectedPlan.installmentAvailable) {
                            document.getElementById('installmentFields').style.display = 'block';
                            setupInstallmentOptions();
                        } else {
                            showError('هذه الباقة غير متاحة للتقسيط');
                            this.classList.remove('selected');
                            paymentMethod = '';
                        }
                    }
                });
            });
            
            // إعداد خيارات التقسيط
            document.getElementById('installmentMonths')?.addEventListener('change', function() {
                setupInstallmentOptions();
            });
            
            // إكمال الاشتراك
            document.getElementById('completeSubscription').addEventListener('click', async () => {
                if (!document.getElementById('agreeTerms').checked) {
                    showError('يجب الموافقة على الشروط والأحكام أولاً');
                    return;
                }
                
                await completeSubscription();
            });
        }

        // إعداد خيارات التقسيط
        function setupInstallmentOptions() {
            if (!selectedPlan || paymentMethod !== 'installment') return;
            
            const months = parseInt(document.getElementById('installmentMonths').value);
            const monthlyPayment = Math.ceil(selectedPlan.price / months);
            const today = new Date();
            const nextPaymentDate = new Date(today.getFullYear(), today.getMonth() + 1, 15);
            
            document.getElementById('installmentCount').textContent = months;
            document.getElementById('installmentAmount').textContent = monthlyPayment;
            document.getElementById('nextPaymentDate').textContent = nextPaymentDate.getDate();
            
            document.getElementById('installmentSummary').style.display = 'block';
            
            installmentPlan = {
                months,
                monthlyPayment,
                nextPaymentDate: nextPaymentDate.toISOString().split('T')[0]
            };
            
            updateSummary();
        }

        // التحقق من معلومات الدفع
        function validatePaymentInfo() {
            // التحقق من طريقة الدفع
            if (!paymentMethod) {
                showError('الرجاء اختيار طريقة الدفع');
                return false;
            }
            
            // التحقق من بيانات المستخدم
            if (isGuestCheckout) {
                const guestPhone = document.getElementById('guestPhone').value.trim();
                if (!guestPhone) {
                    showError('رقم الهاتف مطلوب للدفع كضيف');
                    return false;
                }
                
                if (!/^01[0-2,5]{1}[0-9]{8}$/.test(guestPhone)) {
                    showError('رقم الهاتف غير صحيح. يجب أن يبدأ بـ 01 ويتكون من 11 رقماً');
                    return false;
                }
            } else {
                const fullName = document.getElementById('fullName').value.trim();
                const email = document.getElementById('email').value.trim();
                const phone = document.getElementById('phone').value.trim();
                
                if (!fullName || !email || !phone) {
                    showError('الرجاء ملء جميع الحقول المطلوبة');
                    return false;
                }
                
                if (!/^\S+@\S+\.\S+$/.test(email)) {
                    showError('البريد الإلكتروني غير صحيح');
                    return false;
                }
                
                if (!/^01[0-2,5]{1}[0-9]{8}$/.test(phone)) {
                    showError('رقم الهاتف غير صحيح. يجب أن يبدأ بـ 01 ويتكون من 11 رقماً');
                    return false;
                }
            }
            
            // التحقق من تفاصيل الدفع حسب الطريقة
            if (paymentMethod === 'credit_card') {
                const cardNumber = document.getElementById('cardNumber').value.trim();
                const expiryDate = document.getElementById('expiryDate').value.trim();
                const cvv = document.getElementById('cvv').value.trim();
                
                if (!cardNumber || !expiryDate || !cvv) {
                    showError('الرجاء إدخال جميع تفاصيل بطاقة الائتمان');
                    return false;
                }
                
                if (!/^\d{16}$/.test(cardNumber.replace(/\s/g, ''))) {
                    showError('رقم البطاقة يجب أن يتكون من 16 رقم');
                    return false;
                }
                
                if (!/^\d{3,4}$/.test(cvv)) {
                    showError('رقم CVV غير صحيح');
                    return false;
                }
                
                if (!/^(0[1-9]|1[0-2])\/?([0-9]{2})$/.test(expiryDate)) {
                    showError('تاريخ الانتهاء يجب أن يكون بالصيغة MM/YY');
                    return false;
                }
                
            } else if (paymentMethod === 'vodafone_cash') {
                const transactionId = document.getElementById('vodafoneTransaction').value.trim();
                if (!transactionId) {
                    showError('الرجاء إدخال رقم التحويل');
                    return false;
                }
                
            } else if (paymentMethod === 'bank_transfer') {
                const receiptNumber = document.getElementById('bankReceipt').value.trim();
                if (!receiptNumber) {
                    showError('الرجاء إدخال رقم الإيصال');
                    return false;
                }
            }
            
            return true;
        }

        // إكمال عملية الاشتراك
        async function completeSubscription() {
            const submitBtn = document.getElementById('completeSubscription');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري المعالجة...';
            
            try {
                // جمع بيانات الاشتراك
                const subscriptionData = {
                    planId: selectedPlan.id,
                    planName: selectedPlan.name,
                    startDate: new Date().toISOString().split('T')[0],
                    endDate: calculateEndDate(selectedPlan.duration),
                    paymentStatus: 'pending',
                    paymentAmount: selectedPlan.price,
                    paymentCurrency: selectedPlan.currency,
                    paymentMethod: paymentMethod,
                    transactionId: generateTransactionId(),
                    features: selectedPlan.features.filter(f => f.available).map(f => f.text),
                    status: 'active',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // إضافة بيانات التقسيط إذا كانت متاحة
                if (installmentPlan) {
                    subscriptionData.installmentPlan = installmentPlan;
                    subscriptionData.paymentStatus = 'partial';
                }
                
                // معالجة الدفع كضيف
                if (isGuestCheckout) {
                    const guestPhone = document.getElementById('guestPhone').value.trim();
                    
                    subscriptionData.guestCheckout = true;
                    subscriptionData.guestPhone = guestPhone;
                    
                    // حفظ بيانات الضيف في Firestore
                    const docRef = await db.collection('subscriptions').add(subscriptionData);
                    subscriptionId = docRef.id;
                    
                    // إرسال رسالة تأكيد للضيف
                    await sendConfirmationSMS(guestPhone, subscriptionId);
                    
                } else {
                    // معالجة المستخدم المسجل
                    let user = auth.currentUser;
                    const email = document.getElementById('email').value.trim();
                    const password = document.getElementById('password').value;
                    
                    // إذا لم يكن مسجلاً دخول، ننشئ حساباً جديداً
                    if (!user) {
                        const generatedPassword = password || generateRandomPassword();
                        
                        try {
                            const userCredential = await auth.createUserWithEmailAndPassword(email, generatedPassword);
                            user = userCredential.user;
                            
                            // حفظ بيانات المستخدم الإضافية
                            await db.collection('users').doc(user.uid).set({
                                name: document.getElementById('fullName').value.trim(),
                                phone: document.getElementById('phone').value.trim(),
                                email: email,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            
                            // إذا لم يدخل كلمة مرور، نرسل له كلمة المرور العشوائية
                            if (!password) {
                                await sendWelcomeEmail(email, generatedPassword);
                            }
                            
                        } catch (error) {
                            if (error.code === 'auth/email-already-in-use') {
                                // حاول تسجيل الدخول إذا كان الحساب موجوداً
                                const userCredential = await auth.signInWithEmailAndPassword(email, password || prompt('يوجد حساب بهذا البريد، الرجاء إدخال كلمة المرور:'));
                                user = userCredential.user;
                            } else {
                                throw error;
                            }
                        }
                    }
                    
                    // إضافة بيانات المستخدم إلى الاشتراك
                    subscriptionData.userId = user.uid;
                    subscriptionData.userEmail = email;
                    subscriptionData.userName = document.getElementById('fullName').value.trim();
                    subscriptionData.userPhone = document.getElementById('phone').value.trim();
                    
                    // حفظ الاشتراك في Firestore
                    const docRef = await db.collection('subscriptions').add(subscriptionData);
                    subscriptionId = docRef.id;
                    
                    // تحديث بيانات المستخدم
                    await db.collection('users').doc(user.uid).update({
                        subscriptionId: docRef.id,
                        subscriptionPlan: selectedPlan.id,
                        subscriptionStatus: 'active',
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                // إضافة تفاصيل الدفع حسب الطريقة
                if (paymentMethod === 'vodafone_cash') {
                    subscriptionData.vodafoneTransaction = document.getElementById('vodafoneTransaction').value.trim();
                } else if (paymentMethod === 'bank_transfer') {
                    subscriptionData.bankReceipt = document.getElementById('bankReceipt').value.trim();
                } else if (paymentMethod === 'credit_card') {
                    subscriptionData.cardLast4 = document.getElementById('cardNumber').value.trim().slice(-4);
                }
                
                // الانتقال إلى صفحة النجاح
                goToStep(4);
                
            } catch (error) {
                console.error('Error completing subscription:', error);
                
                let errorMessage = 'حدث خطأ أثناء عملية الاشتراك';
                if (error.code === 'auth/weak-password') {
                    errorMessage = 'كلمة المرور يجب أن تكون 6 أحرف على الأقل';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'البريد الإلكتروني غير صحيح';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                showError(errorMessage);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> اكمل الاشتراك';
            }
        }

        // إرسال رسالة ترحيب للمستخدم الجديد
        async function sendWelcomeEmail(email, password) {
            const sendEmail = functions.httpsCallable('sendWelcomeEmail');
            try {
                await sendEmail({ email, password });
            } catch (error) {
                console.error('Error sending welcome email:', error);
            }
        }

        // إرسال رسالة تأكيد للضيف
        async function sendConfirmationSMS(phone, subscriptionId) {
            const sendSMS = functions.httpsCallable('sendConfirmationSMS');
            try {
                await sendSMS({ 
                    phone, 
                    message: `تم اشتراكك بنجاح في LeenClasses. رقم الاشتراك: ${subscriptionId}` 
                });
            } catch (error) {
                console.error('Error sending confirmation SMS:', error);
            }
        }

        // حساب تاريخ الانتهاء
        function calculateEndDate(months) {
            const date = new Date();
            date.setMonth(date.getMonth() + parseInt(months));
            return date.toISOString().split('T')[0];
        }

        // إنشاء رقم معاملة فريد
        function generateTransactionId() {
            return 'SUB-' + Date.now().toString().slice(-6) + Math.floor(Math.random() * 100).toString().padStart(2, '0');
        }

        // إنشاء كلمة مرور عشوائية
        function generateRandomPassword() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let password = '';
            for (let i = 0; i < 8; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return password;
        }
    </script>
</body>
</html>